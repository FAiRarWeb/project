<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindAR Project</title>

    <!-- MindAR + A-Frame Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.7/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #startup-screen {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #111;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        transition: opacity 0.5s ease;
      }

      #startup-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .checkmark-container {
        font-size: 48px;
        color: limegreen;
        display: none;
        margin-bottom: 20px;
      }

      .checkmark-container.show {
        display: block;
      }

      #loading-text {
        font-size: 18px;
        margin-bottom: 20px;
      }

      #loading-text.ready {
        color: limegreen;
      }

      #start-button {
        padding: 10px 20px;
        font-size: 18px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.5s;
      }

      #start-button.show {
        opacity: 1;
      }

      #toggleButton, #googleButton {
        position: absolute;
        z-index: 20;
        font-weight: bold;
        cursor: pointer;
        transform-origin: center;
      }

      #toggleButton {
        top: 10px;
        right: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 5px;
        padding: 8px 12px;
        display: none;
      }

      #googleButton {
        background-color: #4285F4;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 15px;
        display: none;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="startup-screen">
      <div class="loading-spinner" id="loading-spinner"></div>
      <div class="checkmark-container" id="checkmark-container">âœ”</div>
      <div id="loading-text">Loading assets...</div>
      <button id="start-button" onclick="startARExperience()">Start Experience</button>
    </div>

    <button id="toggleButton">Show Button</button>
    <button id="googleButton" onclick="window.open('https://www.google.com', '_blank')">i</button>

    <a-scene
      id="ar-scene"
      mindar-image="imageTargetSrc: https://fairarweb.github.io/project/target.mind"
      embedded
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      style="display: none"
    >
      <a-assets>
        <video id="ar-video" src="https://fairarweb.github.io/project/videoAR.mp4" preload="auto" loop="true" muted playsinline crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" videohandler>
        <a-video
          src="#ar-video"
          width="1"
          height="0.6"
          position="0 0 0"
          autoplay="true"
          loop="true"
          visible="false"
        ></a-video>
      </a-entity>
    </a-scene>

    <script>
      const startButton = document.getElementById("start-button");
      const loadingSpinner = document.getElementById("loading-spinner");
      const checkmarkContainer = document.getElementById("checkmark-container");
      const loadingText = document.getElementById("loading-text");
      const startupScreen = document.getElementById("startup-screen");
      const arScene = document.getElementById("ar-scene");

      function startARExperience() {
        startupScreen.classList.add("hidden");
        arScene.style.display = "block";
      }

      window.addEventListener("load", () => {
        setTimeout(() => {
          loadingSpinner.classList.add("hidden");
          checkmarkContainer.classList.add("show");
          loadingText.textContent = "Ready!";
          loadingText.classList.add("ready");
          startButton.classList.add("show");
        }, 2500);
      });

      AFRAME.registerComponent("videohandler", {
        init: function () {
          const videoEl = document.querySelector("#ar-video");
          const videoPlane = this.el.querySelector("a-video");
          const toggleButton = document.querySelector("#toggleButton");
          const googleButton = document.querySelector("#googleButton");
          const camera = document.querySelector("a-camera").object3D;

          let deviceOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';

          window.addEventListener("deviceorientation", (event) => {
            const gamma = Math.abs(event.gamma);
            const newOrientation = (gamma > 45 && gamma < 135) ? 'landscape' : 'portrait';
            if (newOrientation !== deviceOrientation) {
              deviceOrientation = newOrientation;
              updateLayout(deviceOrientation);
            }
          }, true);

          const updateLayout = (orientation) => {
            if (orientation === 'landscape') {
              videoPlane.setAttribute("rotation", "0 0 0");
              toggleButton.style.top = "auto";
              toggleButton.style.bottom = "80px";
              toggleButton.style.right = "10px";
              toggleButton.style.transform = "rotate(90deg)";
              googleButton.style.transform = "rotate(90deg)";
            } else {
              videoPlane.setAttribute("rotation", "0 0 0");
              toggleButton.style.top = "10px";
              toggleButton.style.bottom = "auto";
              toggleButton.style.right = "10px";
              toggleButton.style.transform = "rotate(0deg)";
              googleButton.style.transform = "translate(-50%, -50%) scale(1)";
            }
          };

          updateLayout(deviceOrientation);

          this.el.addEventListener("targetFound", () => {
            videoPlane.setAttribute("visible", true);
            videoEl.play().catch(e => console.warn("Autoplay blocked:", e));
            toggleButton.style.display = "block";
            updateLayout(deviceOrientation);
          });

          this.el.addEventListener("targetLost", () => {
            videoEl.pause();
            videoPlane.setAttribute("visible", false);
            toggleButton.style.display = "none";
            googleButton.style.display = "none";
          });

          toggleButton.addEventListener("click", () => {
            const isHidden = googleButton.style.display === "none" || googleButton.style.display === "";
            googleButton.style.display = isHidden ? "block" : "none";
            toggleButton.textContent = isHidden ? "Hide Button" : "Show Button";
          });

          this.tick = () => {
            if (googleButton.style.display !== "block" || !videoPlane.getAttribute("visible")) return;

            const videoWorldPosition = new THREE.Vector3();
            videoPlane.object3D.getWorldPosition(videoWorldPosition);

            const vector = videoWorldPosition.clone();
            vector.project(camera.children[0]);

            const widthHalf = window.innerWidth / 2;
            const heightHalf = window.innerHeight / 2;
            const x = (vector.x * widthHalf) + widthHalf;
            const y = -(vector.y * heightHalf) + heightHalf;

            const distance = camera.position.distanceTo(videoWorldPosition);
            const scaleFactor = Math.max(0.5, Math.min(1.5, 1 / Math.max(0.1, distance)));

            if (deviceOrientation === 'landscape') {
              googleButton.style.left = `${x + 10}px`;
              googleButton.style.top = `${y - 90}px`;
            } else {
              googleButton.style.left = `${x}px`;
              googleButton.style.top = `${y}px`;
            }

            const rotation = deviceOrientation === 'landscape' ? 'rotate(90deg)' : 'rotate(0deg)';
            googleButton.style.transform = `translate(-50%, -50%) scale(${scaleFactor}) ${rotation}`;
          };
        },
      });
    </script>
  </body>
</html>
