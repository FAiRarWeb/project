<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>MindAR Demo with Extra Buttons</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/aframe/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      .control-button,
      .btn1-button,
      .btn2-button,
      .btn3-button,
      .btn4-button {
        position: absolute;
        z-index: 20;
        font-weight: bold;
        cursor: pointer;
        background-color: rgba(76, 175, 80, 0.8);
        border-radius: 8px;
        padding: 10px 15px;
        display: none;
        border: none;
        font-size: 16px;
        color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
        transform-origin: center center;
        transition: all 0.3s ease;
        text-align: center;
        white-space: nowrap;
      }

      .control-button:hover,
      .btn1-button:hover,
      .btn2-button:hover,
      .btn3-button:hover,
      .btn4-button:hover {
        background-color: rgba(76, 175, 80, 1);
        transform: scale(1.1) translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      }

      .control-button.pressed,
      .btn1-button.pressed,
      .btn2-button.pressed,
      .btn3-button.pressed,
      .btn4-button.pressed {
        background-color: #2E7D32;
      }

      #googleButton {
        position: absolute;
        z-index: 30;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 10px 20px;
        border-radius: 12px;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-family: sans-serif;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <!-- Original Buttons -->
    <button id="animateButton" class="control-button">Animate</button>
    <button id="infoButton" class="control-button">Info</button>
    <div id="googleButton">Learn More on Google</div>

    <!-- New Buttons -->
    <button id="btn1" class="control-button btn1-button">Btn 1</button>
    <button id="btn2" class="control-button btn2-button">Btn 2</button>
    <button id="btn3" class="control-button btn3-button">Btn 3</button>
    <button id="btn4" class="control-button btn4-button">Btn 4</button>

    <!-- MindAR Scene -->
    <a-scene mindar-image="imageTargetSrc: ./targets.mind;" embedded color-space="sRGB" renderer="antialias: true; alpha: true;" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: true">
      <a-assets>
        <video id="video1" src="./video.mp4" preload="auto" loop="true" crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" videohandler>
        <a-video src="#video1" width="1" height="0.56" position="0 0 0" rotation="0 0 0" visible="false"></a-video>
      </a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent("videohandler", {
        init: function () {
          const videoEl = document.querySelector("#video1");
          const videoPlane = this.el.querySelector("a-video");
          const animateButton = document.querySelector("#animateButton");
          const infoButton = document.querySelector("#infoButton");
          const googleButton = document.querySelector("#googleButton");
          const btn1 = document.querySelector("#btn1");
          const btn2 = document.querySelector("#btn2");
          const btn3 = document.querySelector("#btn3");
          const btn4 = document.querySelector("#btn4");

          const camera = document.querySelector("a-camera").object3D;
          let deviceOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
          let isAnimatePressed = false;
          let isTargetFound = false;

          const PORTRAIT = {
            animateButton: { bottom: "20px", right: "20px" },
            infoButton: { bottom: "80px", right: "20px" },
            btn1: { bottom: "140px", right: "20px" },
            btn2: { bottom: "200px", right: "20px" },
            btn3: { bottom: "260px", right: "20px" },
            btn4: { bottom: "320px", right: "20px" }
          };

          const LANDSCAPE = {
            animateButton: { bottom: "10%", right: "66%" },
            infoButton: { bottom: "6%", right: "60%" },
            btn1: { bottom: "20%", right: "66%" },
            btn2: { bottom: "30%", right: "66%" },
            btn3: { bottom: "40%", right: "66%" },
            btn4: { bottom: "50%", right: "66%" }
          };

          const updateLayout = (orientation) => {
            const layout = orientation === "landscape" ? LANDSCAPE : PORTRAIT;
            const rotate = orientation === "landscape" ? "rotate(90deg)" : "rotate(0deg)";

            const applyStyle = (btn, pos) => {
              btn.style.bottom = pos.bottom;
              btn.style.right = pos.right;
              btn.style.transform = rotate;
            };

            applyStyle(animateButton, layout.animateButton);
            applyStyle(infoButton, layout.infoButton);
            applyStyle(btn1, layout.btn1);
            applyStyle(btn2, layout.btn2);
            applyStyle(btn3, layout.btn3);
            applyStyle(btn4, layout.btn4);

            if (googleButton.style.display === "block") {
              googleButton.style.transform = `translate(-50%, -50%) scale(1) ${rotate}`;
            }
          };

          window.addEventListener("resize", () => {
            const newOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
            if (newOrientation !== deviceOrientation) {
              deviceOrientation = newOrientation;
              updateLayout(deviceOrientation);
            }
          });

          window.addEventListener("orientationchange", () => {
            setTimeout(() => {
              const newOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
              deviceOrientation = newOrientation;
              updateLayout(deviceOrientation);
            }, 100);
          });

          updateLayout(deviceOrientation);

          const checkAndPlayVideo = () => {
            if (isAnimatePressed && isTargetFound) {
              videoPlane.setAttribute("visible", true);
              videoEl.play().catch((e) => console.warn("Autoplay blocked:", e));
            } else {
              videoPlane.setAttribute("visible", false);
              videoEl.pause();
            }
          };

          this.el.addEventListener("targetFound", () => {
            isTargetFound = true;
            animateButton.style.display = "block";
            infoButton.style.display = "block";
            btn1.style.display = "block";
            btn2.style.display = "block";
            btn3.style.display = "block";
            btn4.style.display = "block";
            updateLayout(deviceOrientation);
            checkAndPlayVideo();
          });

          this.el.addEventListener("targetLost", () => {
            isTargetFound = false;
            videoEl.pause();
            videoPlane.setAttribute("visible", false);
            animateButton.style.display = "none";
            infoButton.style.display = "none";
            googleButton.style.display = "none";
            btn1.style.display = "none";
            btn2.style.display = "none";
            btn3.style.display = "none";
            btn4.style.display = "none";
            isAnimatePressed = false;
          });

          animateButton.addEventListener("click", () => {
            animateButton.classList.toggle("pressed");
            isAnimatePressed = !isAnimatePressed;
            if (isAnimatePressed) {
              googleButton.style.display = "none";
            }
            checkAndPlayVideo();
          });

          infoButton.addEventListener("click", () => {
            const isHidden = googleButton.style.display === "none" || googleButton.style.display === "";
            if (isHidden) {
              infoButton.classList.add("pressed");
              googleButton.style.display = "block";
              videoPlane.setAttribute("visible", false);
              videoEl.pause();
              isAnimatePressed = false;
              animateButton.classList.remove("pressed");
            } else {
              infoButton.classList.remove("pressed");
              googleButton.style.display = "none";
            }
          });

          [btn1, btn2, btn3, btn4].forEach((btn) => {
            btn.addEventListener("click", () => {
              btn.classList.toggle("pressed");
              isAnimatePressed = !isAnimatePressed;
              checkAndPlayVideo();
            });
          });

          this.tick = () => {
            if (googleButton.style.display !== "block" || !isTargetFound) return;

            const videoWorldPosition = new THREE.Vector3();
            videoPlane.object3D.getWorldPosition(videoWorldPosition);
            const vector = videoWorldPosition.clone().project(camera.children[0]);
            const widthHalf = window.innerWidth / 2;
            const heightHalf = window.innerHeight / 2;
            const x = (vector.x * widthHalf) + widthHalf;
            const y = -(vector.y * heightHalf) + heightHalf;

            const distance = camera.position.distanceTo(videoWorldPosition);
            const scaleFactor = Math.max(0.5, Math.min(1.5, 1 / Math.max(0.1, distance)));

            const rotation = deviceOrientation === 'landscape' ? 'rotate(90deg)' : 'rotate(0deg)';
            googleButton.style.left = `${x}px`;
            googleButton.style.top = `${y}px`;
            googleButton.style.transform = `translate(-50%, -50%) scale(${scaleFactor}) ${rotation}`;
          };
        },
      });
    </script>
  </body>
</html>
